<!doctype html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="author" content="Paul Lewis" />
  <meta name="viewport" content="width=device-width">
  <meta name="theme-color" content="#89C13D">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="//aerotwist.com/lab/feed/">
  

  

  <style>
    
    @font-face {
      font-family: 'Lato';
      font-style: normal;
      font-weight: 400;
      src: local('Lato Regular'), local('Lato-Regular'), url(//themes.googleusercontent.com/static/fonts/lato/v7/qIIYRU-oROkIk8vfvxw6QvesZW2xOQ-xsNqO47m55DA.woff) format('woff');
    }
    

    @font-face {
      font-family: 'Lato';
      font-style: normal;
      font-weight: 700;
      src: local('Lato Bold'), local('Lato-Bold'), url(//themes.googleusercontent.com/static/fonts/lato/v7/qdgUG4U09HnJwhYI-uK18wLUuEpTyoUstqEm5AMlJo4.woff) format('woff');
    }
  </style>

  <link rel="stylesheet" media="screen" href="/css/aerotwist.css" />
  <title>Aerotwist - Music DNA</title>
  
  <style>
    .masthead h2 {
      display: none;
    }

    .masthead {
      background-image: url(/static/lab/headers/header-music-dna-small.jpg);
      
      background-color: #111;
      
      
    }

    .meta {
      background-color: #111 !important;
    }

    @media (min-width: 600px) {
      .masthead {
        background-image: url(/static/lab/headers/header-music-dna.jpg);
      }
    }
  </style>
  
</head>


<!--
                              __          .__          __
  _____    ___________  _____/  |___  _  _|__| _______/  |_
  \__  \ _/ __ \_  __ \/  _ \   __\ \/ \/ /  |/  ___/\   __\
   / __ \\  ___/|  | \(  <_> )  |  \     /|  |\___ \  |  |
  (____  /\___  >__|   \____/|__|   \/\_/ |__/____  > |__|
       \/     \/                                  \/

  Giant ascii art embedded in every page of your site is how you
  show other people that YOU CARE. Mainly I care about developers,
  which is what I presume you are if you're all about viewing
  the source. Clearly you're my kind of person.

  This is v3, it's run through Jekyll, it's been fun to build,
  there's always more to do, and you may notice that aside from
  Google Analytics there is no JavaScript. None.

  That's one way of many you keep your pages fast. I care about
  keeping this site fast because your time is precious and I need
  to get out of your way.

  <3'z

  Paul
-->


  <body class="lab">

    <header>
      <div class="container">
        <div id="logo">
  <a href="/">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
       width="100%" height="100%">
    <g>
      <polygon fill-rule="evenodd" clip-rule="evenodd" fill="#CCDBD4" points="30.6,47.73 64.92,47.73 19.97,76.52"></polygon>
      <polygon fill-rule="evenodd" clip-rule="evenodd" fill="#FFF194" points="48.198,0 53.008,14.06 39.31,24.76"></polygon>
      <polygon fill-rule="evenodd" clip-rule="evenodd" fill="#89C13D" points="39.31,24.76 64.92,48 30.6,48"></polygon>
      <polygon fill-rule="evenodd" clip-rule="evenodd" fill="#EADF3E" points="39.31,24.76 64.92,48 53.008,14.06"></polygon>
      <polygon fill-rule="evenodd" clip-rule="evenodd" fill="#004C26" points="30.6,48 64.92,48 48,58.69"></polygon>
      <polygon fill-rule="evenodd" clip-rule="evenodd" fill="#7FA592" points="47.76,58.69 64.92,47.73 75.14,76.73"></polygon>
    </g>
    </svg>
  </a>
</div>

        <nav>
  <ul>
    
      
        <li><a href="/">Home</a></li>
      
    
      
        <li><a href="/blog/">Blog</a></li>
      
    
      
        <li><a href="/tutorials/">Tutorials</a></li>
      
    
      
        <li class="active"><a href="/lab/"> Lab</a></li>
      
    
  </ul>

  <svg id="left-line" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
       width="380px" height="380px" viewBox="0 0 380 380">
    <line x1="0" y1="380" x2="380" y2="0" stroke="#AAAAAA" stroke-width="1" />
    </svg>

  <svg id="right-line" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
       width="380px" height="380px" viewBox="0 0 380 380">
    <line x1="0" y1="380" x2="380" y2="0" stroke="#CCDBD4" stroke-opacity="0.3" stroke-width="1" />
    </svg>
</nav>

      </div>
    </header>
    <section>

      <div class="content">

  <div class="masthead">

    

    <div class="container">
      <h2>Music DNA</h2>
      <p></p>
    </div>

  </div>

  <div class="container"><div class="left column">
<p class="livedemo"><a href="http://lab.aerotwist.com/canvas/music-dna/">See the experiment</a></p>

<p>I had what I thought was a fairly simple idea: what if I took a song and mapped its frequencies in a dial? The whole song would equate to 360° and each slice of the song’s “pie” would be coloured up according to the active frequencies at that point in the song. That was the rough idea, and given I had a 10 hour flight to San Francisco looming, I thought I would see what I could get done.</p>

<h2 id="audio-analysis">Audio Analysis</h2>

<p>This is actually super easy to do with the Web Audio API. It has an FFT analyser built right in, and given the Web Audio API acts like a node graph, it’s simple to set up:</p>

</div></div>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Create the context</span>
<span class="kd">var</span> <span class="nx">audioContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AudioContext</span><span class="p">();</span>

<span class="c1">// Now create our nodes</span>
<span class="kd">var</span> <span class="nx">analyser</span> <span class="o">=</span> <span class="nx">audioContext</span><span class="p">.</span><span class="nx">createAnalyser</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">sourceNode</span> <span class="o">=</span> <span class="nx">audioContext</span><span class="p">.</span><span class="nx">createBufferSource</span><span class="p">();</span>

<span class="c1">// Then hook them together</span>
<span class="nx">sourceNode</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">analyser</span><span class="p">);</span>
<span class="nx">analyser</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">audioContext</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span></code></pre></div>

<div class="container"><div class="left column">

<p>Now all you do is tell the sound to play and, during the rendering, you ask for the current data from the analyser:</p>

</div></div>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Get the frequency data out of the analyser</span>
<span class="c1">// and shove it in arrayBuffer.</span>
<span class="nx">analyser</span><span class="p">.</span><span class="nx">getByteFrequencyData</span><span class="p">(</span><span class="nx">arrayBuffer</span><span class="p">);</span></code></pre></div>

<div class="container"><div class="left column">

<p>One thing I didn’t realise at first was that a <code>bufferSourceNode</code> (which I call <code>sourceNode</code> in my code) are sort-of “one-shot nodes”, which you specifically <em>can’t re-use</em>. They’re kind of a view onto the audio data (which you can, of course, re-use), but the general idea is that you make one, use it, and <a href="https://www.youtube.com/watch?v=J5Xu9UcOdj0">fuggedabowdit</a>. Anyway, just thought I’d mention that.</p>

<h2 id="rendering-the-dial">Rendering the dial</h2>

<p>This is where the majority of my time went. The idea behind a lot of my creative coding is that I don’t really know what I’m <em>actually</em> trying to make, I’ll just try some stuff and see where it takes me. I have to have something that I think is a solid idea before I get going, of course, and up to this point I knew roughly what I wanted to make and I’d focused on having the data ready.</p>

<p>During the coding I actually thought to take screenshots (which I normally forget) just so I could show you a little bit of the process. Here’s what the rendering looked like at various points:</p>

<figure>
  <img src="/static/lab/music-dna/dial-1.png" alt="So white!" />
  <figcaption>So white!</figcaption>
</figure>

<p>Basically at this point the rendering worked and that was about it. My overriding concern was to make sure that the rough shape and size was correct. But it clearly needed, uhhh, more love.</p>

<figure>
  <img src="/static/lab/music-dna/dial-2.png" alt="Randomized colouring." />
  <figcaption>Randomized colouring.</figcaption>
</figure>

<p>I figured out pretty quickly that I wanted colour rather than an all-white output. I tried a couple of things here:</p>

<ul>
  <li><strong>Completely random colouring</strong>. Just pick a random hue and go crazy! Wooo! Looked awful.</li>
  <li><strong>Hue-based colouring, both single cycle and multi-cycle</strong>. So here for the single-cycle I just mapped the angle of where I’m rendering to the hue, which is easy because both a circle and HSL values are in the range of 0 to 360. For the multi-cycle I just wrapped around a few times (which is the picture above) and it looked hideous.</li>
</ul>

<figure>
  <img src="/static/lab/music-dna/dial-3.png" alt="Single hue cycle, getting nearer..." />
  <figcaption>Single hue cycle, getting nearer...</figcaption>
</figure>

<p>Eventually I settled it down to a single cycle, which you can see above. I also added a couple of other things:</p>

<ul>
  <li><strong>A threshold</strong>. Part of the problem of the early versions was that the data kind of overwhelmed the visualization. There was simply too much getting rendered. By adding a threshold to the whole thing only a few key frequencies per slice actually make the cut.</li>
  <li><strong>Some contrast</strong>. I decided that another issue was that I was seeing a lot of small dots, and it needed some contrast. Entirely at random (<code>if (Math.random() &gt; 0.999) ...</code>) I promote some dots to being bigger splodges. A side effect of this is that as more data gets past the threshold we get more splodges. That means the louder areas are glowier and niiiiice!</li>
</ul>

<figure>
  <img src="/static/lab/music-dna/dial-2b.png" alt="More colours, but too much noise." />
  <figcaption>More colours, but too much noise.</figcaption>
</figure>

<p>And then…</p>

<figure>
  <img src="/static/lab/music-dna/dial-4.png" alt="The final look." />
  <figcaption>The final look.</figcaption>
</figure>

<p>Finally after some <a href="https://github.com/paullewis/music-dna/blob/master/audio-renderer.js#L62-77">serious number fishing</a> (sport of Kings and Queens) I managed to settle on something that I thought looked pretty.</p>

<h2 id="an-accessibility-concern">An accessibility concern</h2>

<p>I got called out by <a href="https://plus.google.com/u/0/103580453482564328019/posts">Sven Schwedas</a> about the fact that I had failed to offer an <code>&lt;form&gt;</code> for people who couldn’t use the default drag-and-drop functionality.</p>

<figure>
  <img src="/static/lab/music-dna/accessibility.png" alt="Sven Schwedas called me out" />
  <figcaption>Got that one wrong, Lewis. Well done.</figcaption>
</figure>

<p>My initial response was, in honesty, frustration, not because I don’t care about accessibility (far from it), but because my <em>main aim</em> had been to create a fun little doodle. Fixing it was trivial but, actually, <em>I was wrong not to include accessibility in my thinking from the start</em>.</p>

<p>I’ve said that accessibility (like security and performance) <a href="//aerotwist.com/blog/web-components-and-three-unsexy-pillars/">need to be an underpinning attitude to development</a>, so I should’ve applied it to my own work. Hopefully I’ll get that right next time.</p>

<h2 id="next-steps">Next steps</h2>

<p>There’s been a lot of fantastic feedback from the people who have played with Music DNA. I already felt like I wanted to do more with it, but the feedback has entirely validated those ideas. So what’s next?</p>

<ul>
  <li><strong>High Resolution Save</strong>. The idea of getting a <em>print quality</em> output from the visualization is super appealing to me. I have no idea if it’s going to be possible, because of the sheer memory weight of creating large canvas elements, but I intend to find out!</li>
  <li><strong>Multi-track Visualizations</strong>. I was asked if it could be extended to cover multiple tracks. I think that’s a super neat idea; it would be awesome to get a dial (or collection of dials) for a whole album. I think being realistic it’s more like once we have…</li>
  <li><strong>Offline mode</strong>. It’s nice to be able to listen to the track and watch the visualization appear, but I think a nice addition would be to analyze a file and spit out the graphic much more quickly, for which we need to process the audio as quickly as possible and for which we have the offline audio context. Unfortunately the offline audio context in Chrome has bugs around JavaScript nodes (boooo!) so I’m toying with other approaches.</li>
  <li><strong>Normalized analysis</strong>. I had to pick values for the audio gain and so on that favours professionally mastered pop and electronic. The downside is it doesn’t work as well for quiet or loud music, and I think there’s something I can do to have the analyser adapt to the volume of the audio. We’ll see.</li>
  <li><strong>Integration with [insert music service here]</strong>. I would <em>love</em> this, but I doubt it’ll be possible. Well, <a href="http://soundcloud.com">Soundcloud</a> seems like the most likely, but I would personally be super excited if there was some way I could get integrated with Google Music, Spotify or another streaming service.</li>
</ul>

<p>I’ve filed <a href="https://github.com/paullewis/music-dna/issues">bugs for all of them</a>. Onwards!</p>

</div></div>



</div>


    </section>

    <footer>

      <div class="container">
        <div class="bio panel">
          <h2>Hello!</h2>
          <p>My name is Paul. I work at <a href="http://www.google.com/" title="Some cloud company in the USA, I think.">Google</a> on the Chrome Developer Relations team as an advocate. I help developers improve the performance of their sites and apps.</p>

          <p>You can find me on <a href="http://twitter.com/aerotwist">Twitter</a> and <a href="http://www.google.com/+aerotwist">G+</a></p>
        </div>

        <div class="get-in-touch panel">
          <h2>Get in touch</h2>
          <p>I don’t bite. Honestly. You can find me on <a href="https://twitter.com/aerotwist">Twitter</a> and <a href="http://www.google.com/+aerotwist">G+</a>, and I like hearing from people (pretty handy given my job, really) so say hi.</p>
        </div>

        <div class="subscribe panel">
          <h2>Subscribe</h2>
          <p>You should totally get the <a href="/blog/feed/">RSS feed</a>, or whatever it is you kids are using these days (I miss Reader.)</p>
        </div>

        <p class="disclaimer">Except as otherwise noted, the content of this page is licensed under the Creative Commons Attribution 3.0 License, and code samples are licensed under the Apache 2.0 License.</p>
      </div>
    </footer>

    <script async="true">

    /**
     * Snow effect, from: HTML5 Rocks
     * https://github.com/html5rocks/www.html5rocks.com/blob/9318b5755c8c17a4bd1761bca6b1b491e7fd17b8/content/index.html
     */
    !function(){function j(){f=c.clientWidth,g=c.clientHeight,d.width=f,d.height=g,e.fillStyle="#FFF";var a=i;i=f>600,!a&&i&&requestAnimFrame(n)}function n(){if(e.clearRect(0,0,f,g),i){for(h=0;b>h;h++)m=l[h],m.y+=m.vy,m.x+=m.vx,e.globalAlpha=m.o,e.beginPath(),e.arc(m.x,m.y,m.r,0,2*Math.PI,!1),e.closePath(),e.fill(),m.y>g&&m.reset();requestAnimFrame(n)}}var a=(new Date).getMonth();if(11===a){var b=100,c=document.querySelector(".masthead");if(c){var d=document.createElement("canvas"),e=d.getContext("2d"),f=c.clientWidth,g=c.clientHeight,h=0,i=!1,k=function(){this.x=0,this.y=0,this.vy=0,this.vx=0,this.r=0,this.reset()};k.prototype.reset=function(){this.x=Math.random()*f,this.y=Math.random()*-g,this.vy=1+3*Math.random(),this.vx=.5-Math.random(),this.r=1+2*Math.random(),this.o=.5+.5*Math.random()},d.style.position="absolute",d.style.left=d.style.top="0";var m,l=[];for(h=0;b>h;h++)m=new k,m.reset(),l.push(m);window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),j(),window.addEventListener("resize",j,!1),c.appendChild(d)}}

    if (new Date().getMonth() !== 11) {
      return;
    }

    if (!('IntersectionObserver' in window)) {
      return;
    }

    var masthead = document.querySelector('.masthead');
    if (!masthead) {
      return;
    }

    var observer = new IntersectionObserver(function(entries) {
      entries.sort(function(a, b) {
        return b.time - a.time;
      });

      var isActive = i;
      i = entries[0].intersectionRatio > 0.01;

      if (i && !isActive) {
        console.log('***** LET IT SNOWWWWW!!!! *****');
        requestAnimFrame(n);
      } else {
        if (i !== isActive) {
          console.log('Forecast: no snow.');
        }
      }

    }, { rootMargin: '0px', threshold: 0.01 });

    observer.observe(masthead);
    }();
    </script>

    <script type="text/javascript" async="true">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-13024693-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
